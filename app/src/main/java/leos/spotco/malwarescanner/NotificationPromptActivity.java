package us.spotco.malwarescanner;


import android.app.Activity;
import android.app.AlertDialog;
import android.app.NotificationManager;
import android.content.Context;
import android.content.Intent;
import android.content.pm.ApplicationInfo;
import android.content.pm.PackageManager;
import android.net.Uri;
import android.os.Bundle;
import android.util.Log;
import android.view.ViewGroup;
import android.widget.Toast;

import java.io.File;
import java.util.Objects;

public class NotificationPromptActivity extends Activity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        getWindow().setLayout(
                ViewGroup.LayoutParams.MATCH_PARENT,
                ViewGroup.LayoutParams.WRAP_CONTENT
        );
        Intent intent = getIntent();
        Context context = this;
        switch (Objects.requireNonNull(intent.getAction())) {
            case "us.spotco.malwarescanner.LOOKUP_HASH":
                if (Objects.requireNonNull(intent.getStringExtra("HASH")).length() == 64) {
                    String hashsum = intent.getStringExtra("HASH");
                    AlertDialog lookupDialog = new AlertDialog.Builder(this)
                            .setTitle(R.string.confirm_lookup_title)
                            .setMessage(getString(R.string.confirm_lookup_summary) + "\n>>>" + hashsum.substring(0, 8) + "<<<")
                            .setIcon(android.R.drawable.ic_dialog_alert)
                            .setPositiveButton(android.R.string.yes, (dialog, whichButton) -> {
                                Intent lookupIntent = new Intent(Intent.ACTION_VIEW, Uri.parse("https://www.virustotal.com/gui/file/" + hashsum));
                                startActivity(lookupIntent);
                                finish();
                            })
                            .setNegativeButton(android.R.string.no, (dialog, whichButton) -> finish())
                            .create();
                    lookupDialog.setOnDismissListener((dialog) -> finish());
                    lookupDialog.show();
                } else {
                    Log.d("Hypatia", "Invalid hash");
                    finish();
                }
                break;
            case "us.spotco.malwarescanner.DELETE_FILE":
                if (intent.getPackage() == null || Objects.equals(intent.getPackage(), BuildConfig.APPLICATION_ID)) {
                    File matched = new File(Objects.requireNonNull(intent.getStringExtra("FILE_PATH")));
                    if (matched.exists() && matched.isFile()) {
                        AlertDialog deleteDialog = new AlertDialog.Builder(this)
                                .setTitle(R.string.confirm_delete_title)
                                .setMessage(getString(R.string.confirm_delete_summary) + "\n>>>" + matched.getName() + "<<<")
                                .setIcon(android.R.drawable.ic_dialog_alert)
                                .setPositiveButton(android.R.string.yes, (dialog, whichButton) -> {
                                    if (matched.delete()) {
                                        Toast.makeText(context, getString(R.string.deleted), Toast.LENGTH_SHORT).show();
                                    } else {
                                        Toast.makeText(context, getString(R.string.delete_failed), Toast.LENGTH_SHORT).show();
                                    }
                                    clearNotification(context, intent.getIntExtra("NOTIFICATION_ID", 0));
                                    finish();
                                })
                                .setNegativeButton(android.R.string.no, (dialog, whichButton) -> finish())
                                .create();
                        deleteDialog.setOnDismissListener((dialog) -> finish());
                        deleteDialog.show();
                    } else {
                        finish();
                    }
                } else {
                    Log.d("Hypatia", "Ignoring DELETE_FILE request from external package: " + intent.getPackage());
                    finish();
                }
                break;
            case "us.spotco.malwarescanner.UNINSTALL_APP":
                if (intent.getPackage() == null || Objects.equals(intent.getPackage(), BuildConfig.APPLICATION_ID)) {
                    if (intent.getStringExtra("FILE_PATH") != null) {
                        boolean notFound = true;
                        for (ApplicationInfo packageInfo : getPackageManager().getInstalledApplications(PackageManager.GET_META_DATA)) {
                            if (packageInfo.sourceDir.equals(intent.getStringExtra("FILE_PATH"))) {
                                notFound = false;
                                Uri packageUri = Uri.parse("package:" + packageInfo.packageName);
                                Intent uninstallIntent = new Intent(Intent.ACTION_UNINSTALL_PACKAGE, packageUri);
                                startActivity(uninstallIntent);
                                clearNotification(context, intent.getIntExtra("NOTIFICATION_ID", 0));
                                finish();
                            }
                        }
                        if (notFound) {
                            finish();
                        }
                    } else {
                        finish();
                    }
                } else {
                    Log.d("Hypatia", "Ignoring DELETE_FILE request from external package: " + intent.getPackage());
                    finish();
                }
                break;
            case "us.spotco.malwarescanner.IGNORE_DETECTION":
                Toast.makeText(context, getString(R.string.ignored), Toast.LENGTH_SHORT).show();
                clearNotification(context, intent.getIntExtra("NOTIFICATION_ID", 0));
                finish();
                break;
        }
    }

    private static void clearNotification(Context context, int id) {
        NotificationManager notificationManager = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);
        if (id != 0) {
            notificationManager.cancel(id);
            Log.d("Hypatia", "Canceled notification");
        }
    }

    @Override
    public void onBackPressed() {
        finish();
    }
}